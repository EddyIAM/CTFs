# Challenge report for Malware Traffic Analysis 1 - SO Edition

- **Challenge Name: Malware Traffic Analysis 1**
- **Date: 12/10/2021**
- **URL: <https://cyberdefenders.org/labs/17>**
- **Status:Complete**

***

## Description

This is the second time I've done this CTF.  This time instead of using the suggested tools I thought I'd try it with Security Onion.

Before we start lets clear out the NSM.

```bash
[eddy@so ~]$ sudo so-nsm-clear
```

Once all cleared we will import the pcap.

```bash
[eddy@so MTA1]$ sudo so-import-pcap mta1.pcap 
Processing Import: /home/eddy/ctfs/cyberdefenders.org/MTA1/mta1.pcap
- verifying file
- assigning unique identifier to import: 41d34d07aa81f3cb5ee12315cc5c88a9
- analyzing traffic with Suricata
- analyzing traffic with Zeek
- saving PCAP data spanning dates 2014-11-16 through 2014-11-16

Cleaning up:

Import complete!

You can use the following hyperlink to view data in the time range of your import.  You can triple-click to quickly highlight the entire hyperlink and you can then copy it into your browser:
<https://xxx.xxx.xxx.xxx/#/hunt?q=import.id:41d34d07aa81f3cb5ee12315cc5c88a9%20%7C%20groupby%20event.module%20event.dataset&t=2014%2F11%2F16%2000%3A00%3A00%20AM%20-%202014%2F11%2F17%2000%3A00%3A00%20AM&z=UTC>

or you can manually set your Time Range to be (in UTC):
From: 2014-11-16    To: 2014-11-17
```

## Analysis

1. What is the IP address of the Windows VM that gets infected?

    **172.16.165.165**

    ```text
    Lets look in Hunt and see who stands out using; "suricata" | groupby event.module event.dataset.

    172.16.165.165 is clearly the winner.
    ```

    ![flag1](/CyberDefenders/MTA1/images/Flag1.png)

2. What is the hostname of the Windows VM that gets infected?

    **K34EN6W3N-PC**

    ```text
    Again lets look in Hunt using; "dhcp" | groupby event.module event.dataset.

    Looks like the second record is a DHCP request.  Host.hostname has what we are looking for.

    Actually we can narrow down even further; "dhcp" AND dhcp.message_types: "REQUEST" AND dhcp.message_types:"ACK" | groupby event.module event.dataset.
    ```

    ![flag2](/CyberDefenders/MTA1/images/Flag2.png)

3. What is the MAC address of the infected VM?

    **f0:19:af:02:9b:f1**

    ```text
    We can actually just re-use the Hunt from question 2 and look at host.mac for your answer.

    "dhcp" AND dhcp.message_types: "REQUEST" AND dhcp.message_types:"ACK" | groupby event.module event.dataset host.mac.
    ```

4. What is the IP address of the compromised web site?

    **82.150.140.30**

    ```text
    First we go back to "suricata" | groupby event.module event.dataset.  Unfortunately nothing stands out.  Lets widen the search to "http" | groupby event.module event.dataset and see what we find.

    Looks like it all begins with us talking to 82.150.140.30.
    ```

    ![flag4](/CyberDefenders/MTA1/images/Flag4.png)

5. What is the FQDN of the compromised website?
  
    **ciniholland.nl**

    ```text
    since we know the IP lets ask DNS about it; "82.150.140.30" AND event.dataset:DNS | groupby dns.query.name destination.port.  Hey, what do you know.  First result!
    ```

    ![flag5](/CyberDefenders/MTA1/images/Flag5.png)

6. What is the IP address of the server that delivered the exploit kit and malware?
  
    **37.200.69.143**

    ```text
    Lets look in Hunt again and see who stands out in the Suricata Alerts; "suricata" | groupby event.module event.dataset.
    
    37.200.69.143 is the clear winner with several ET EXPLOIT_KIT alerts.
    ```

    ![flag1](/CyberDefenders/MTA1/images/Flag1.png)

7. What is the FQDN that delivered the exploit kit and malware?
  
    **stand.trustandprobaterealty.com**

    ```text
    Just like question 5 we can ask DNS about it; "37.200.69.143" AND event.dataset:DNS | groupby dns.query.name destination.port.
    ```

    ![flag7](/CyberDefenders/MTA1/images/Flag7.png)

8. What is the redirect URL that points to the exploit kit (EK) landing page?
  
    **<http://24corp-shop.com/>**

    ```text
    Lets look at http again and see what referrers there are; event.dataset:http | groupby http.referrer
    ```

    ![flag8](/CyberDefenders/MTA1/images/Flag8.png)

9. Other than CVE-2013-2551 IE exploit, another application was targeted by the EK and starts with "J". Provide the full application name.
  
    **Java**

    ```text
    Again we go back to the original Hunt of; "suricata" | groupby event.module event.dataset.   We can cleary see Java being targetted.
    ```

    ![flag1](/CyberDefenders/MTA1/images/Flag1.png)

10. How many times was the payload delivered?

    **3**

    ```text
    ???  Security Onion shows a lot of stuff but none seems to come out to a 3?
    ```

11. No 11?

12. The compromised website has a malicious script with a URL What is this URL?

    **<http://24corp-shop.com/>**

    ```text
    This one takes a little work.  While we know the answer from number 8 above I still wanted to find the script.
    We know where the script is so best I think we can do is load up all the HTTP sessions from the server (event.dataset:http AND destination.ip:"82.150.140.30") and go through each one by doing Action -> PCAP on each log.id.uid.
    ```

    ![flag12](/CyberDefenders/MTA1/images/Flag12.png)

    ![flag12a](/CyberDefenders/MTA1/images/Flag12a.png)

13. Extract the two exploit files. What are the MD5 file hashes? (comma-separated )

    **7b3baa7d6bb3720f369219789e38d6ab,1e34fdebbf655cebea78b45e43520ddf**

    ```text
    We know from the Alerts we are looking for a Flash file and a Java file and we also know what server they are coming from.  So...

    event.dataset:file AND source.ip: "37.200.69.143" AND (file.mime_type:"application/java-archive" OR file.mime_type:"application/x-shockwave-flash") | groupby file.source source.ip hash.md5

    ```

    ![flag13](/CyberDefenders/MTA1/images/Flag13.png)

## Lessons Learned

That was fun.  I think I will do a couple more using Security Onion.
